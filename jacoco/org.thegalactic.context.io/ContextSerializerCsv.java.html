<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContextSerializerCsv.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lattices</a> &gt; <a href="index.source.html" class="el_package">org.thegalactic.context.io</a> &gt; <span class="el_source">ContextSerializerCsv.java</span></div><h1>ContextSerializerCsv.java</h1><pre class="source lang-java linenums">package org.thegalactic.context.io;

/*
 * ContextSerializerCsv.java
 *
 * Copyright: 2010-2015 Karell Bertet, France
 * Copyright: 2015-2016 The Galactic Organization, France
 *
 * License: http://www.cecill.info/licences/Licence_CeCILL-B_V1-en.html CeCILL-B license
 *
 * This file is part of java-lattices.
 * You can redistribute it and/or modify it under the terms of the CeCILL-B license.
 */
import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.IOException;
import java.util.List;
import java.util.TreeSet;

import org.apache.commons.csv.CSVFormat;
import org.apache.commons.csv.CSVParser;
import org.apache.commons.csv.CSVPrinter;
import org.apache.commons.csv.CSVRecord;

import org.thegalactic.context.Context;
import org.thegalactic.io.Reader;
import org.thegalactic.io.Writer;

/**
 * This class defines the way for reading a context from a csv file.
 *
 * ![ContextSerializerCsv](ContextSerializerCsv.png)
 *
 * @uml ContextSerializerCsv.png
 * !include resources/org/thegalactic/context/io/ContextSerializerCsv.iuml
 * !include resources/org/thegalactic/io/Reader.iuml
 * !include resources/org/thegalactic/io/Writer.iuml
 *
 * hide members
 * show ContextSerializerCsv members
 * class ContextSerializerCsv #LightCyan
 * title ContextSerializerCsv UML graph
 */
public final class ContextSerializerCsv implements Reader&lt;Context&gt;, Writer&lt;Context&gt; {

    /**
     * The singleton instance.
     */
<span class="fc" id="L49">    private static final ContextSerializerCsv INSTANCE = new ContextSerializerCsv();</span>

    /**
     * Return the singleton instance of this class.
     *
     * @return the singleton instance
     */
    public static ContextSerializerCsv getInstance() {
<span class="fc" id="L57">        return INSTANCE;</span>
    }

    /**
     * Register this class for reading .csv files.
     */
    public static void register() {
<span class="fc" id="L64">        ContextIOFactory.getInstance().registerReader(ContextSerializerCsv.getInstance(), &quot;csv&quot;);</span>
<span class="fc" id="L65">        ContextIOFactory.getInstance().registerWriter(ContextSerializerCsv.getInstance(), &quot;csv&quot;);</span>
<span class="fc" id="L66">    }</span>

    /**
     * This class is not designed to be publicly instantiated.
     */
<span class="fc" id="L71">    private ContextSerializerCsv() {</span>
<span class="fc" id="L72">    }</span>

    /**
     * Read a context from a csv file.
     *
     * The following format is respected:
     *
     * The first line contains the attribute names, the other lines contains the
     * observations identifier followed by boolean values
     *
     * ~~~
     * &quot;&quot;,a,b,c,d,e
     * 1,1,0,1,0,0
     * 2,1,1,0,0,0
     * 3,0,1,0,1,1
     * 4,0,0,1,0,1
     * ~~~
     *
     * If the first attribute is the empty string, the first column corresponds
     * to the individual identifiers. In the other case, the individual
     * identifiers will be generated by successive integers.
     *
     * ~~~
     * a,b,c,d,e
     * 1,0,1,0,0
     * 1,1,0,0,0
     * 0,1,0,1,1
     * 0,0,1,0,1
     * ~~~
     *
     * @param context a context to read
     * @param file    a file
     *
     * @throws IOException When an IOException occurs
     */
    public void read(Context context, BufferedReader file) throws IOException {
        // Parse the file
<span class="fc" id="L109">        CSVParser parser = CSVFormat.RFC4180.parse(file);</span>

        // Get the records and record size
<span class="fc" id="L112">        List&lt;CSVRecord&gt; records = parser.getRecords();</span>
<span class="fc" id="L113">        int length = records.size();</span>

        // Verify length
<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (length == 0) {</span>
<span class="fc" id="L117">            throw new IOException(&quot;CSV cannot be empty&quot;);</span>
        }

        // Get the attributes and the attribute size
<span class="fc" id="L121">        CSVRecord attributes = records.get(0);</span>
<span class="fc" id="L122">        int size = attributes.size();</span>

        // Detect invalid attribute size
<span class="fc bfc" id="L125" title="All 4 branches covered.">        if (size == 1 &amp;&amp; attributes.get(0).equals(&quot;&quot;)) {</span>
<span class="fc" id="L126">            throw new IOException(&quot;Attribute size cannot be 0&quot;);</span>
        }

        // Index of the first attribute
<span class="fc" id="L130">        int first = 0;</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (attributes.get(0).equals(&quot;&quot;)) {</span>
<span class="fc" id="L132">            first = 1;</span>
        }

        // Get the attributes
<span class="fc bfc" id="L136" title="All 2 branches covered.">        for (int i = first; i &lt; size; i++) {</span>
<span class="fc" id="L137">            String attribute = attributes.get(i);</span>

            // Detect duplicated attribute
<span class="fc bfc" id="L140" title="All 2 branches covered.">            if (!context.addToAttributes(attribute)) {</span>
<span class="fc" id="L141">                throw new IOException(&quot;Duplicated attribute&quot;);</span>
            }

            // Detect empty attribute
<span class="fc bfc" id="L145" title="All 2 branches covered.">            if (&quot;&quot;.equals(attribute)) {</span>
<span class="fc" id="L146">                throw new IOException(&quot;Empty attribute&quot;);</span>
            }
        }

        // Get the data
<span class="fc bfc" id="L151" title="All 2 branches covered.">        for (int j = 1; j &lt; length; j++) {</span>
            // Get the current record
<span class="fc" id="L153">            CSVRecord record = records.get(j);</span>

            // Detect incorrect size
<span class="fc bfc" id="L156" title="All 2 branches covered.">            if (record.size() != size) {</span>
<span class="fc" id="L157">                throw new IOException(&quot;Line does not have the correct number of attributes&quot;);</span>
            }

            // Get the observation identifier
            String identifier;
<span class="fc bfc" id="L162" title="All 2 branches covered.">            if (first == 1) {</span>
<span class="fc" id="L163">                identifier = record.get(0);</span>
            } else {
<span class="fc" id="L165">                identifier = String.valueOf(j);</span>
            }

            // Detect duplicated identifier
<span class="fc bfc" id="L169" title="All 2 branches covered.">            if (!context.addToObservations(identifier)) {</span>
<span class="fc" id="L170">                throw new IOException(&quot;Duplicated identifier&quot;);</span>
            }

            // Add the extent/intent for the current identifier and current attribute
<span class="fc bfc" id="L174" title="All 2 branches covered.">            for (int i = first; i &lt; size; i++) {</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">                if (record.get(i).equals(&quot;1&quot;)) {</span>
<span class="fc" id="L176">                    context.addExtentIntent(identifier, attributes.get(i));</span>
                }
            }
        }

        // Close the parser
<span class="fc" id="L182">        parser.close();</span>
<span class="fc" id="L183">        context.setBitSets();</span>
<span class="fc" id="L184">    }</span>

    /**
     * Write a context to a csv file.
     *
     * The following format is respected:
     *
     * The first line contains the attribute names, the other lines contains the
     * observations identifier followed by boolean values
     *
     * ~~~
     * &quot;&quot;,a,b,c,d,e
     * 1,1,0,1,0,0
     * 2,1,1,0,0,0
     * 3,0,1,0,1,1
     * 4,0,0,1,0,1
     * ~~~
     *
     * @param context a context to write
     * @param file    a file
     *
     * @throws IOException When an IOException occurs
     */
    public void write(Context context, BufferedWriter file) throws IOException {
<span class="fc" id="L208">        CSVPrinter printer = new CSVPrinter(file, CSVFormat.RFC4180);</span>

        // Get the observations and the attributes
<span class="fc" id="L211">        TreeSet&lt;Comparable&gt; observations = context.getObservations();</span>
<span class="fc" id="L212">        TreeSet&lt;Comparable&gt; attributes = context.getAttributes();</span>

        // Prepare the attribute line
<span class="fc" id="L215">        printer.print(&quot;&quot;);</span>

<span class="fc bfc" id="L217" title="All 2 branches covered.">        for (Comparable attribute : attributes) {</span>
            // Write each attribute
<span class="fc" id="L219">            printer.print(attribute);</span>
<span class="fc" id="L220">        }</span>

<span class="fc" id="L222">        printer.println();</span>

<span class="fc bfc" id="L224" title="All 2 branches covered.">        for (Comparable observation : observations) {</span>
            // Write the observation
<span class="fc" id="L226">            printer.print(observation);</span>

            // Write the extent/intents
<span class="fc bfc" id="L229" title="All 2 branches covered.">            for (Comparable attribute : attributes) {</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">                if (context.getIntent(observation).contains(attribute)) {</span>
<span class="fc" id="L231">                    printer.print(1);</span>
                } else {
<span class="fc" id="L233">                    printer.print(0);</span>
                }
<span class="fc" id="L235">            }</span>

<span class="fc" id="L237">            printer.println();</span>
<span class="fc" id="L238">        }</span>

<span class="fc" id="L240">        printer.close();</span>
<span class="fc" id="L241">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>